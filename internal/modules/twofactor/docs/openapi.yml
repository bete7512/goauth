paths:
  # Two-Factor Authentication Routes
  /2fa/setup:
    post:
      summary: Setup two-factor authentication
      description: Initialize 2FA setup for the authenticated user and get QR code
      tags: [Two-Factor Authentication Module]
      security:
        - cookieAuth: []
        - bearerAuth: []
      responses:
        '200':
          description: 2FA setup initiated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TwoFactorSetupResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /2fa/verify:
    post:
      summary: Verify and enable two-factor authentication
      description: Verify the TOTP code from authenticator app and enable 2FA
      tags: [Two-Factor Authentication Module]
      security:
        - cookieAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TwoFactorVerifyRequest'
      responses:
        '200':
          description: 2FA enabled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Invalid code or not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /2fa/disable:
    post:
      summary: Disable two-factor authentication
      description: Disable 2FA for the authenticated user. Requires current TOTP code to confirm.
      tags: [Two-Factor Authentication Module]
      security:
        - cookieAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TwoFactorVerifyRequest'
      responses:
        '200':
          description: 2FA disabled successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Invalid or missing code
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /2fa/verify-login:
    post:
      summary: Complete login with two-factor authentication
      description: |
        Submit a TOTP code (or backup code) to complete the login flow after receiving
        a `TWO_FACTOR_REQUIRED` challenge from the login endpoint.
        Use the `temp_token` returned by the login challenge in the request body.
        On success, returns the same tokens as a normal login response.
      tags: [Two-Factor Authentication Module]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TwoFactorVerifyLoginRequest'
      responses:
        '200':
          description: 2FA verified — authentication tokens issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TwoFactorAuthResponse'
        '400':
          description: Missing or invalid request fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Invalid or expired temp_token / wrong TOTP code
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /2fa/status:
    get:
      summary: Get two-factor authentication status
      description: Retrieve the current 2FA status for the authenticated user
      tags: [Two-Factor Authentication Module]
      security:
        - cookieAuth: []
        - bearerAuth: []
      responses:
        '200':
          description: 2FA status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TwoFactorStatusResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  # Security schemes are now defined globally in the swagger generator
  # This allows for dynamic configuration based on user settings
  # Supported schemes: cookieAuth (cookie-based) and bearerAuth (JWT Bearer token)
  
  schemas:
    # Request Schemas
    TwoFactorVerifyRequest:
      type: object
      required: [code]
      properties:
        code:
          type: string
          example: "123456"
          description: 6-digit TOTP code from authenticator app (or 8-character backup code e.g. "ABCD-EFGH")

    TwoFactorVerifyLoginRequest:
      type: object
      required: [code]
      properties:
        temp_token:
          type: string
          example: "eyJhbGci..."
          description: Temporary token from the TWO_FACTOR_REQUIRED login challenge (preferred)
        user_id:
          type: string
          format: uuid
          example: "6c9c5673-b6cb-40d5-97c0-aba3886fac68"
          description: User ID fallback (use temp_token instead when available)
        code:
          type: string
          example: "123456"
          description: 6-digit TOTP code from authenticator app, or 8-character backup code (e.g. "ABCD-EFGH")

    # Response Schemas
    TwoFactorSetupResponse:
      type: object
      properties:
        secret:
          type: string
          example: JBSWY3DPEHPK3PXP
          description: TOTP secret key (base32 encoded) — store securely
        qr_url:
          type: string
          format: uri
          example: otpauth://totp/GoAuth:user@example.com?secret=JBSWY3DPEHPK3PXP&issuer=GoAuth
          description: QR code URL — scan with authenticator app (Google Authenticator, Authy, etc.)
        backup_codes:
          type: array
          items:
            type: string
          example: ["ABCD-EFGH", "IJKL-MNOP"]
          description: One-time backup codes — save these securely, shown only once
        message:
          type: string
          example: "Scan the QR code with your authenticator app, then verify with a code to enable 2FA"
          description: Setup instructions

    TwoFactorAuthResponse:
      type: object
      properties:
        access_token:
          type: string
          description: JWT access token
        refresh_token:
          type: string
          description: Refresh token
        session_id:
          type: string
          format: uuid
          description: Session ID (session-based auth only)
        expires_in:
          type: integer
          example: 2592000
          description: Access token TTL in seconds
        user:
          type: object
          properties:
            id:
              type: string
              format: uuid
            email:
              type: string
              format: email
            name:
              type: string
        message:
          type: string
          example: "2FA verification successful - tokens issued"

    TwoFactorStatusResponse:
      type: object
      properties:
        enabled:
          type: boolean
          example: true
          description: Whether 2FA is enabled
        verified:
          type: boolean
          example: true
          description: Whether 2FA has been verified
        method:
          type: string
          example: totp
          enum: [totp, sms, email]
          description: 2FA method being used

    MessageResponse:
      type: object
      properties:
        message:
          type: string
          example: Two-factor authentication enabled successfully
          description: Response message
        success:
          type: boolean
          example: true
          description: Operation success status

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          example: Invalid code
          description: Error message
        message:
          type: string
          example: The provided verification code is invalid
          description: Additional error information
        code:
          type: integer
          example: 401
          description: HTTP status code

tags:
  - name: Two-Factor Authentication Module
    description: Two-factor authentication (2FA) endpoints for enhanced account security

